generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
}

/// User accounts with authentication via Clerk
model User {
  id                 String              @id @default(uuid()) @db.Uuid
  email              String              @unique @db.VarChar(255)
  phone              String?             @db.VarChar(20)
  fullName           String?             @map("full_name") @db.VarChar(255)
  firstName          String?             @map("first_name") @db.VarChar(100)
  lastName           String?             @map("last_name") @db.VarChar(100)
  is_active          Boolean?            @default(true)
  imageUrl           String?             @map("image_url")
  college            String?
  yearOfStudy        String?             @map("year_of_study")
  rollNumber         String?             @map("roll_number")
  branch             String?
  startup_name       String?             @db.VarChar(255)
  startup_stage      String?             @db.VarChar(100)
  industry           String?             @db.VarChar(100)
  company_name       String?             @db.VarChar(255)
  designation        String?             @db.VarChar(100)
  company_size       String?             @db.VarChar(50)
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  lastLogin          DateTime?           @map("last_login") @db.Timestamptz(6)
  bookingId          String?             @unique @map("booking_id") @db.VarChar(255)
  bookingVerified    Boolean             @default(false) @map("booking_verified")
  clerkUserId        String?             @unique @map("clerk_user_id") @db.VarChar(255)
  passes             Pass[]
  transactions       Transaction[]

  @@index([email], type: Hash)
  @@index([phone])
  @@index([clerkUserId], type: Hash)
  @@index([createdAt(sort: Desc)])
  @@map("users")
}

/// Event passes with access control
model Pass {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @map("user_id") @db.Uuid
  passType          String        @map("pass_type") @db.VarChar(50)
  passId            String        @unique @map("pass_id") @db.VarChar(100)
  bookingId         String?       @map("booking_id") @db.VarChar(255)
  konfhubTicketId   String?       @map("konfhub_ticket_id") @db.VarChar(255)
  konfhubOrderId    String?       @map("konfhub_order_id") @db.VarChar(255)
  konfhubData       Json?         @map("konfhub_data")
  isThakurStudent   Boolean?      @map("is_thakur_student") @default(false)
  price             Decimal?      @db.Decimal(10, 2)
  purchaseDate      DateTime?     @map("purchase_date") @db.Timestamptz(6)
  ticketDetails     Json?         @map("ticket_details")
  status            String        @default("Active")
  hasWorkshopAccess Boolean?      @map("has_workshop_access")
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  transaction       Transaction?
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([passId], type: Hash)
  @@index([konfhubTicketId])
  @@index([status])
  @@index([passType])
  @@map("passes")
}

/// Payment transactions for passes (handled by KonfHub)
model Transaction {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  passId            String?  @unique @map("pass_id") @db.Uuid
  invoiceNumber     String?  @unique @map("invoice_number") @db.VarChar(100)
  transactionNumber String?  @unique @map("transaction_number") @db.VarChar(100)
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("INR") @db.VarChar(10)
  status            String   @default("pending") @db.VarChar(50)
  paymentMethod     String?  @default("konfhub") @map("payment_method") @db.VarChar(50)
  konfhubOrderId    String?  @map("konfhub_order_id") @db.VarChar(255)
  konfhubTicketId   String?  @map("konfhub_ticket_id") @db.VarChar(255)
  konfhubPaymentId  String?  @map("konfhub_payment_id") @db.VarChar(255)
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  pass              Pass?    @relation(fields: [passId], references: [id], onDelete: SetNull)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([passId])
  @@index([status])
  @@index([konfhubOrderId])
  @@map("transactions")
}


