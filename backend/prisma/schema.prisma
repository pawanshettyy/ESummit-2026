generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

/// User accounts with authentication via Clerk
model User {
  id                 String              @id @default(uuid()) @db.Uuid
  email              String              @unique @db.VarChar(255)
  phone              String?             @db.VarChar(20)
  password           String?             @db.VarChar(255)
  fullName           String?             @map("full_name") @db.VarChar(255)
  firstName          String?             @map("first_name") @db.VarChar(100)
  lastName           String?             @map("last_name") @db.VarChar(100)
  user_type          UserType?
  email_verified     Boolean?            @default(false)
  phone_verified     Boolean?            @default(false)
  is_active          Boolean?            @default(true)
  imageUrl           String?             @map("image_url")
  college            String?
  yearOfStudy        String?             @map("year_of_study")
  rollNumber         String?             @map("roll_number")
  startup_name       String?             @db.VarChar(255)
  startup_stage      String?             @db.VarChar(100)
  industry           String?             @db.VarChar(100)
  company_name       String?             @db.VarChar(255)
  designation        String?             @db.VarChar(100)
  company_size       String?             @db.VarChar(50)
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  lastLogin          DateTime?           @map("last_login") @db.Timestamptz(6)
  bookingId          String?             @unique @map("booking_id") @db.VarChar(255)
  bookedPassType     String?             @map("booked_pass_type") @db.VarChar(50)
  bookingVerified    Boolean             @default(false) @map("booking_verified")
  clerkUserId        String?             @unique @map("clerk_user_id") @db.VarChar(255)
  checkIns           CheckIn[]
  eventRegistrations EventRegistration[]
  otp_codes          otp_codes[]
  passes             Pass[]

  @@index([email], type: Hash)
  @@index([phone])
  @@index([clerkUserId], type: Hash)
  @@index([createdAt(sort: Desc)])
  @@index([user_type])
  @@map("users")
}

/// Event passes with QR codes and access control
model Pass {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @map("user_id") @db.Uuid
  passType          String        @map("pass_type") @db.VarChar(50)
  passId            String        @unique @map("pass_id") @db.VarChar(100)
  bookingId         String?       @map("booking_id") @db.VarChar(255)
  konfhubTicketId   String?       @map("konfhub_ticket_id") @db.VarChar(255)
  konfhubOrderId    String?       @map("konfhub_order_id") @db.VarChar(255)
  price             Decimal?      @db.Decimal(10, 2)
  purchaseDate      DateTime?     @map("purchase_date") @db.Timestamptz(6)
  ticketDetails     Json?         @map("ticket_details")
  status            String        @default("Active")
  qrCodeUrl         String?       @map("qr_code_url")
  qrCodeData        String?       @map("qr_code_data")
  hasMeals          Boolean       @default(false) @map("has_meals")
  hasMerchandise    Boolean       @default(false) @map("has_merchandise")
  hasWorkshopAccess Boolean       @default(false) @map("has_workshop_access")
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  checkIns          CheckIn[]
  transaction       Transaction?
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([passId], type: Hash)
  @@index([konfhubTicketId])
  @@index([status])
  @@index([passType])
  @@map("passes")
}

/// Payment transactions for passes (handled by KonfHub)
model Transaction {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  passId            String?  @unique @map("pass_id") @db.Uuid
  invoiceNumber     String?  @unique @map("invoice_number") @db.VarChar(100)
  transactionNumber String?  @unique @map("transaction_number") @db.VarChar(100)
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("INR") @db.VarChar(10)
  status            String   @default("pending") @db.VarChar(50)
  paymentMethod     String?  @default("konfhub") @map("payment_method") @db.VarChar(50)
  konfhubOrderId    String?  @map("konfhub_order_id") @db.VarChar(255)
  konfhubTicketId   String?  @map("konfhub_ticket_id") @db.VarChar(255)
  konfhubPaymentId  String?  @map("konfhub_payment_id") @db.VarChar(255)
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  pass              Pass?    @relation(fields: [passId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([passId])
  @@index([status])
  @@index([konfhubOrderId])
  @@map("transactions")
}

/// Events and competitions at E-Summit
model Event {
  id                   String              @id @default(uuid()) @db.Uuid
  title                String              @db.VarChar(255)
  description          String?
  category             String              @db.VarChar(100)
  date                 DateTime            @db.Date
  startTime            DateTime            @db.Time(6)
  endTime              DateTime            @db.Time(6)
  venue                String              @db.VarChar(255)
  prizeAmount          Decimal?            @map("prize_amount") @db.Decimal(12, 2)
  eligibility          String?
  rules                Json?
  judges               Json?
  prerequisites        String?
  registrationDeadline DateTime?           @map("registration_deadline") @db.Timestamptz(6)
  speakerName          String?             @map("speaker_name") @db.VarChar(255)
  speakerBio           String?             @map("speaker_bio")
  speakerImageUrl      String?             @map("speaker_image_url")
  maxParticipants      Int?                @map("max_participants")
  currentParticipants  Int                 @default(0) @map("current_participants")
  status               String              @default("upcoming") @db.VarChar(50)
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  eventId              String?             @unique @map("event_id") @db.VarChar(100)
  checkIns             CheckIn[]
  registrations        EventRegistration[]

  @@index([category])
  @@index([date])
  @@index([status])
  @@index([eventId], type: Hash)
  @@index([date, startTime])
  @@map("events")
}

/// Event registrations with team support
model EventRegistration {
  id                  String   @id @default(uuid()) @db.Uuid
  userId              String   @map("user_id") @db.Uuid
  eventId             String   @map("event_id") @db.Uuid
  passId              String?  @map("pass_id") @db.VarChar(100)
  registrationDate    DateTime @default(now()) @map("registration_date") @db.Timestamptz(6)
  status              String   @default("registered") @db.VarChar(50)
  participantName     String?  @map("participant_name") @db.VarChar(255)
  participantEmail    String?  @map("participant_email") @db.VarChar(255)
  participantPhone    String?  @map("participant_phone") @db.VarChar(20)
  teamName            String?  @map("team_name") @db.VarChar(255)
  teamSize            Int?     @map("team_size")
  teamMembers         Json?    @map("team_members")
  isTeamLead          Boolean  @default(true) @map("is_team_lead")
  formData            Json?    @map("form_data")
  specialRequirements String?  @map("special_requirements")
  dietaryPreferences  String?  @map("dietary_preferences") @db.VarChar(255)
  emergencyContact    String?  @map("emergency_contact") @db.VarChar(100)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  event               Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@map("event_registrations")
}

/// Check-in records for events and venue entry
model CheckIn {
  id          String   @id @default(uuid()) @db.Uuid
  passId      String   @map("pass_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  eventId     String?  @map("event_id") @db.Uuid
  checkInTime DateTime @default(now()) @map("check_in_time") @db.Timestamptz(6)
  checkInType String   @map("check_in_type") @db.VarChar(50)
  scannedBy   String?  @map("scanned_by") @db.VarChar(255)
  location    String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  event       Event?   @relation(fields: [eventId], references: [id])
  pass        Pass     @relation(fields: [passId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([passId])
  @@index([userId])
  @@index([eventId])
  @@index([checkInTime(sort: Desc)])
  @@index([scannedBy])
  @@index([userId, eventId])
  @@index([passId, checkInTime(sort: Desc)])
  @@map("check_ins")
}

/// Audit trail for all system actions
model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  action      String   @db.VarChar(100)
  entityType  String   @map("entity_type") @db.VarChar(100)
  entityId    String   @map("entity_id") @db.VarChar(255)
  changes     Json?
  ipAddress   String?  @map("ip_address") @db.Inet
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  clerkUserId String?  @map("clerk_user_id") @db.VarChar(255)

  @@index([clerkUserId])
  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("audit_logs")
}

/// Event sponsors and partners
model Sponsor {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @db.VarChar(255)
  logoUrl      String?  @map("logo_url")
  websiteUrl   String?  @map("website_url")
  tier         String   @db.VarChar(50)
  description  String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tier])
  @@index([displayOrder])
  @@index([isActive, tier, displayOrder])
  @@map("sponsors")
}

/// TCET Student Pass Codes - Pool of unique 6-digit codes for TCET students
model TcetCode {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @unique @db.VarChar(6)
  isAssigned Boolean?  @default(false) @map("is_assigned")
  assignedTo String?   @map("assigned_to") @db.VarChar(255)
  assignedAt DateTime? @map("assigned_at") @db.Timestamptz(6)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isAssigned])
  @@index([assignedTo])
  @@map("tcet_codes")
}

model otp_codes {
  id         String   @id @db.Uuid
  user_id    String?  @db.Uuid
  email      String?  @db.VarChar(255)
  phone      String?  @db.VarChar(20)
  code       String   @db.VarChar(6)
  type       OtpType
  purpose    String   @db.VarChar(50)
  expires_at DateTime @db.Timestamptz(6)
  verified   Boolean  @default(false)
  attempts   Int      @default(0)
  created_at DateTime @default(now())
  users      User?    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([email])
  @@index([expires_at])
  @@index([phone])
}

enum OtpType {
  EMAIL
  PHONE
}

enum UserType {
  STUDENT
  ENTREPRENEUR
  COMPANY
  TCET_STUDENT
}

/// Pending pass claims - Users who uploaded ticket PDF but not yet verified
model PendingPassClaim {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkUserId     String    @map("clerk_user_id") @db.VarChar(255)
  email           String    @db.VarChar(255)
  fullName        String?   @map("full_name") @db.VarChar(255)
  passType        String    @map("pass_type") @db.VarChar(100)
  bookingId       String?   @map("booking_id") @db.VarChar(255)
  konfhubOrderId  String?   @map("konfhub_order_id") @db.VarChar(255)
  ticketNumber    String?   @map("ticket_number") @db.VarChar(255)
  qrCodeData      String?   @map("qr_code_data")
  extractedData   Json?     @map("extracted_data")
  status          String    @default("pending") @db.VarChar(50) // pending, verified, expired, rejected
  verifiedAt      DateTime? @map("verified_at") @db.Timestamptz(6)
  expiresAt       DateTime  @map("expires_at") @db.Timestamptz(6) // 32 hours from creation
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([clerkUserId, bookingId])
  @@index([clerkUserId])
  @@index([status])
  @@index([expiresAt])
  @@index([bookingId])
  @@map("pending_pass_claims")
}
