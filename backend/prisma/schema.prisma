// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String    @id @default(uuid()) // Our internal ID
  
  // Clerk Integration
  clerkUserId       String    @unique @map("clerk_user_id") // Clerk's user ID
  email             String    @unique
  fullName          String?   @map("full_name")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  imageUrl          String?   @map("image_url") // Profile image from Clerk
  
  // Additional User Info
  phone             String?
  college           String?
  yearOfStudy       String?   @map("year_of_study")
  rollNumber        String?   @map("roll_number")
  
  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLogin         DateTime? @map("last_login")
  
  // Relations
  passes            Pass[]
  transactions      Transaction[]
  eventRegistrations EventRegistration[]
  checkIns          CheckIn[]
  
  @@index([email])
  @@index([phone])
  @@index([clerkUserId])
  @@map("users")
}

// ============================================
// PASS MANAGEMENT
// ============================================

model Pass {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  passType      String   @map("pass_type") // 'Gold', 'Silver', 'Platinum', 'Group'
  passId        String   @unique @map("pass_id") // 'ESUMMIT-2025-XXXXX'
  price         Decimal  @db.Decimal(10, 2)
  purchaseDate  DateTime @default(now()) @map("purchase_date")
  status        String   @default("Active") // 'Active', 'Cancelled', 'Refunded'
  
  // Add-ons
  hasMeals      Boolean  @default(false) @map("has_meals")
  hasMerchandise Boolean @default(false) @map("has_merchandise")
  hasWorkshopAccess Boolean @default(false) @map("has_workshop_access")
  
  // QR Code (Phase 2)
  qrCodeUrl     String?  @map("qr_code_url")
  qrCodeData    String?  @map("qr_code_data") @db.Text
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction   Transaction?
  checkIns      CheckIn[]
  
  @@index([userId])
  @@index([passId])
  @@index([status])
  @@map("passes")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

model Transaction {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  passId            String   @unique @map("pass_id")
  
  // Razorpay data
  razorpayOrderId   String?  @unique @map("razorpay_order_id")
  razorpayPaymentId String?  @map("razorpay_payment_id")
  razorpaySignature String?  @map("razorpay_signature")
  
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("INR")
  status            String   // 'pending', 'completed', 'failed', 'refunded'
  paymentMethod     String?  @map("payment_method") // 'upi', 'card', 'netbanking'
  
  metadata          Json?    // Additional payment details
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  user              User     @relation(fields: [userId], references: [id])
  pass              Pass     @relation(fields: [passId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@index([razorpayOrderId])
  @@map("transactions")
}

// ============================================
// EVENT MANAGEMENT
// ============================================

model Event {
  id                String    @id @default(uuid())
  eventId           String?   @unique @map("event_id") // Unique kebab-case identifier (e.g., "workshop-ai-ml-day1-morning")
  title             String
  description       String?   @db.Text
  category          String    // 'competitions', 'workshops', 'speakers', 'hackathon', 'networking'
  
  // Schedule
  date              DateTime  @db.Date
  startTime         DateTime  @db.Time
  endTime           DateTime  @db.Time
  venue             String
  
  // Competition specific
  prizeAmount       Decimal?  @db.Decimal(10, 2) @map("prize_amount")
  eligibility       String?   @db.Text
  rules             Json?
  judges            Json?
  prerequisites     String?   @db.Text
  registrationDeadline DateTime? @map("registration_deadline")
  
  // Speaker specific
  speakerName       String?   @map("speaker_name")
  speakerBio        String?   @db.Text @map("speaker_bio")
  speakerImageUrl   String?   @map("speaker_image_url")
  
  // Capacity
  maxParticipants   Int?      @map("max_participants")
  currentParticipants Int     @default(0) @map("current_participants")
  
  status            String    @default("upcoming") // 'upcoming', 'ongoing', 'completed', 'cancelled'
  
  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Relations
  registrations     EventRegistration[]
  checkIns          CheckIn[]
  
  @@index([category])
  @@index([date])
  @@index([status])
  @@map("events")
}

model EventRegistration {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  eventId          String   @map("event_id")
  passId           String?  @map("pass_id")
  
  registrationDate DateTime @default(now()) @map("registration_date")
  status           String   @default("registered") // 'registered', 'attended', 'cancelled'
  
  teamMembers      Json?    @map("team_members") // For team events
  
  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@map("event_registrations")
}

// ============================================
// CHECK-IN MANAGEMENT
// ============================================

model CheckIn {
  id           String   @id @default(uuid())
  passId       String   @map("pass_id")
  userId       String   @map("user_id")
  eventId      String?  @map("event_id")
  
  checkInTime  DateTime @default(now()) @map("check_in_time")
  checkInType  String   @map("check_in_type") // 'venue_entry', 'event_entry'
  scannedBy    String?  @map("scanned_by") // Admin user ID
  location     String?
  
  // Timestamp
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relations
  pass         Pass     @relation(fields: [passId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
  event        Event?   @relation(fields: [eventId], references: [id])
  admin        AdminUser? @relation(fields: [scannedBy], references: [id])
  
  @@index([passId])
  @@index([userId])
  @@index([eventId])
  @@index([checkInTime])
  @@map("check_ins")
}

// ============================================
// ADMIN MANAGEMENT (Using Clerk publicMetadata.role)
// ============================================

model AdminUser {
  id           String    @id @default(uuid())
  clerkUserId  String?   @unique @map("clerk_user_id") // Admin users managed by Clerk too
  email        String    @unique
  fullName     String    @map("full_name")
  role         String    // 'Super Admin', 'Event Manager', 'Scanner Operator', 'Analytics Viewer'
  
  permissions  Json?     // {"participants": true, "scanner": true, ...}
  
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  
  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  createdBy    String?   @map("created_by")
  
  // Relations
  checkIns     CheckIn[]
  auditLogs    AuditLog[]
  creator      AdminUser?  @relation("AdminHierarchy", fields: [createdBy], references: [id])
  createdAdmins AdminUser[] @relation("AdminHierarchy")
  
  @@index([email])
  @@index([role])
  @@index([clerkUserId])
  @@map("admin_users")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  adminUserId  String?  @map("admin_user_id")
  action       String   // 'check_in', 'refund', 'edit_pass', etc.
  entityType   String   @map("entity_type") // 'pass', 'user', 'event', etc.
  entityId     String   @map("entity_id")
  
  changes      Json?    // Before/after data
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @db.Text @map("user_agent")
  
  // Timestamp
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relations
  admin        AdminUser? @relation(fields: [adminUserId], references: [id])
  
  @@index([adminUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SPONSORS (Optional - for display)
// ============================================

model Sponsor {
  id           String   @id @default(uuid())
  name         String
  logoUrl      String?  @map("logo_url")
  websiteUrl   String?  @map("website_url")
  tier         String   // 'title', 'platinum', 'gold', 'silver', 'bronze'
  description  String?  @db.Text
  
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@index([tier])
  @@index([displayOrder])
  @@map("sponsors")
}
