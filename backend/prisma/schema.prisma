generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  fullName           String?             @map("full_name")
  phone              String?
  college            String?
  yearOfStudy        String?             @map("year_of_study")
  rollNumber         String?             @map("roll_number")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  lastLogin          DateTime?           @map("last_login")
  clerkUserId        String              @unique @map("clerk_user_id")
  firstName          String?             @map("first_name")
  imageUrl           String?             @map("image_url")
  lastName           String?             @map("last_name")
  checkIns           CheckIn[]
  eventRegistrations EventRegistration[]
  passes             Pass[]
  transactions       Transaction[]

  @@index([email])
  @@index([phone])
  @@index([clerkUserId])
  @@map("users")
}

model Pass {
  id                String       @id @default(uuid())
  userId            String       @map("user_id")
  passType          String       @map("pass_type")
  passId            String       @unique @map("pass_id")
  price             Decimal      @db.Decimal(10, 2)
  purchaseDate      DateTime     @default(now()) @map("purchase_date")
  status            String       @default("Active")
  hasMeals          Boolean      @default(false) @map("has_meals")
  hasMerchandise    Boolean      @default(false) @map("has_merchandise")
  hasWorkshopAccess Boolean      @default(false) @map("has_workshop_access")
  qrCodeUrl         String?      @map("qr_code_url")
  qrCodeData        String?      @map("qr_code_data")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  checkIns          CheckIn[]
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction       Transaction?

  @@index([userId])
  @@index([passId])
  @@index([status])
  @@map("passes")
}

model Transaction {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  passId            String?  @unique @map("pass_id")
  razorpayOrderId   String?  @unique @map("razorpay_order_id")
  razorpayPaymentId String?  @map("razorpay_payment_id")
  razorpaySignature String?  @map("razorpay_signature")
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("INR")
  status            String
  paymentMethod     String?  @map("payment_method")
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  invoiceNumber     String   @unique @map("invoice_number")
  transactionNumber String   @unique @map("transaction_number")
  pass              Pass?    @relation(fields: [passId], references: [id])
  user              User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([razorpayOrderId])
  @@index([invoiceNumber])
  @@index([transactionNumber])
  @@map("transactions")
}

model Event {
  id                   String              @id @default(uuid())
  title                String
  description          String?
  category             String
  date                 DateTime            @db.Date
  startTime            DateTime            @db.Time(6)
  endTime              DateTime            @db.Time(6)
  venue                String
  prizeAmount          Decimal?            @map("prize_amount") @db.Decimal(10, 2)
  eligibility          String?
  rules                Json?
  judges               Json?
  prerequisites        String?
  registrationDeadline DateTime?           @map("registration_deadline")
  speakerName          String?             @map("speaker_name")
  speakerBio           String?             @map("speaker_bio")
  speakerImageUrl      String?             @map("speaker_image_url")
  maxParticipants      Int?                @map("max_participants")
  currentParticipants  Int                 @default(0) @map("current_participants")
  status               String              @default("upcoming")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  eventId              String?             @unique @map("event_id")
  checkIns             CheckIn[]
  registrations        EventRegistration[]

  @@index([category])
  @@index([date])
  @@index([status])
  @@map("events")
}

model EventRegistration {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  eventId          String   @map("event_id")
  passId           String?  @map("pass_id")
  registrationDate DateTime @default(now()) @map("registration_date")
  status           String   @default("registered")

  // Basic participant details
  participantName  String? @map("participant_name")
  participantEmail String? @map("participant_email")
  participantPhone String? @map("participant_phone")

  // Team/Group details (for team events)
  teamName    String? @map("team_name")
  teamSize    Int?    @map("team_size")
  teamMembers Json?   @map("team_members")
  isTeamLead  Boolean @default(true) @map("is_team_lead")

  // Event-specific form data (stored as JSON for flexibility)
  formData Json? @map("form_data")

  // Additional fields
  specialRequirements String? @map("special_requirements")
  dietaryPreferences  String? @map("dietary_preferences")
  emergencyContact    String? @map("emergency_contact")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@map("event_registrations")
}

model CheckIn {
  id          String   @id @default(uuid())
  passId      String   @map("pass_id")
  userId      String   @map("user_id")
  eventId     String?  @map("event_id")
  checkInTime DateTime @default(now()) @map("check_in_time")
  checkInType String   @map("check_in_type")
  scannedBy   String?  @map("scanned_by")
  location    String?
  createdAt   DateTime @default(now()) @map("created_at")
  event       Event?   @relation(fields: [eventId], references: [id])
  pass        Pass     @relation(fields: [passId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([passId])
  @@index([userId])
  @@index([eventId])
  @@index([checkInTime])
  @@index([scannedBy])
  @@map("check_ins")
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  changes     Json?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  clerkUserId String?  @map("clerk_user_id")

  @@index([clerkUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Sponsor {
  id           String   @id @default(uuid())
  name         String
  logoUrl      String?  @map("logo_url")
  websiteUrl   String?  @map("website_url")
  tier         String
  description  String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([tier])
  @@index([displayOrder])
  @@map("sponsors")
}
